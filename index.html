<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Anagram Sprint</title>
  <style>
    :root{--bg:#0b1020;--bg2:#0e1530;--card:#101735;--ink:#eef1ff;--muted:#a7afd6;--accent:#80a8ff;--accent2:#b5c8ff;--good:#34d399;--bad:#f87171;--ring:#3651a7}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;padding:0}
    body{font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial;color:var(--ink);background:radial-gradient(1200px 700px at 10% 0%,#0e1a48 0%,transparent 60%),radial-gradient(900px 600px at 90% 100%,#0c1a3d 0%,transparent 65%),linear-gradient(180deg,var(--bg),var(--bg2));display:flex;justify-content:center;align-items:center;padding:12px}
    .wrap{width:100%;max-width:980px}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,0)),var(--card);border:1px solid rgba(132,151,255,.25);border-radius:22px;box-shadow:0 20px 60px rgba(0,0,0,.45),inset 0 0 0 1px rgba(255,255,255,.03);overflow:hidden;max-height:100vh;display:flex;flex-direction:column}
    header{padding:12px 16px;border-bottom:1px solid rgba(132,151,255,.2);display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap}
    header h1{margin:0;font-size:16px;letter-spacing:.3px}
    .pill{font-size:11px;color:var(--muted);padding:4px 8px;border:1px solid rgba(132,151,255,.25);border-radius:999px;backdrop-filter:blur(6px)}
    .progress{height:6px;background:rgba(255,255,255,.06);border-radius:999px;overflow:hidden;position:relative;margin:0 16px}
    .progress-bar{height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--accent2));transition:width .4s ease}
    main{padding:16px;overflow-y:auto;flex:1}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .stats{display:flex;gap:8px;flex-wrap:wrap;color:var(--muted)}
    .kpi{background:rgba(10,16,46,.75);border:1px solid rgba(132,151,255,.25);border-radius:10px;padding:8px 10px;font-size:13px}
    .kpi strong{color:var(--ink)}
    .grid{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin:12px 0}
    .tile{background:rgba(10,16,46,.9);border:1px solid rgba(132,151,255,.25);border-radius:10px;padding:10px;text-align:center;font-weight:800;font-size:20px;letter-spacing:1.5px;box-shadow:0 6px 18px rgba(0,0,0,.25)}
    .controls{display:flex;gap:8px;margin:10px 0;flex-wrap:wrap;justify-content:center}
    button{background:var(--accent);color:#0b1020;border:none;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer;transition:filter .2s ease,transform .06s ease;font-size:14px}
    button:hover{filter:brightness(1.1)}
    button:active{transform:translateY(1px)}
    button.secondary{background:transparent;color:var(--ink);border:1px solid rgba(132,151,255,.35)}
    input[type=text]{width:100%;max-width:100%;padding:12px 14px;border-radius:10px;border:1px solid rgba(132,151,255,.35);background:rgba(10,16,46,.7);color:var(--ink);font-size:15px;outline:none}
    input[type=text]:focus{box-shadow:0 0 0 3px rgba(128,168,255,.2);border-color:var(--ring)}
    .hint{color:var(--muted);font-size:13px;text-align:center}
    .right{color:var(--good);font-weight:700}
    .wrong{color:var(--bad);font-weight:700}
    .footer{padding:12px 16px;border-top:1px solid rgba(132,151,255,.2);color:var(--muted);display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap;font-size:12px}
    table{width:100%;border-collapse:collapse;margin-top:10px;font-size:12px}
    th,td{padding:6px;border-bottom:1px solid rgba(132,151,255,.2);text-align:left}
    .sr{position:absolute;left:-9999px}
    .center{display:grid;place-items:center;text-align:center}
    .nameEntry{display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:center}
    .small{font-size:11px;color:var(--muted)}
    [hidden]{display:none !important}
    @media (max-width:640px){
      header h1{font-size:14px}
      .tile{font-size:16px;padding:8px;letter-spacing:1px}
      button{width:100%;min-height:44px}
      input[type=text]{width:100%;font-size:14px}
      .kpi{font-size:12px;padding:6px 8px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" id="app">
      <header>
        <h1>‚úèÔ∏è Anagram Rush!</h1>
        <div class="pill">Private game ¬∑ 1995 Broadway</div>
      </header>
      <div class="progress"><div class="progress-bar" id="progressBar"></div></div>
      <main>
        <section id="setup">
          <div class="row">
            <div>
              <h2 style="margin:0 0 6px;font-size:18px">Ready?</h2>
              <p class="hint">Theme: NYC neighborhoods + Real Estate.</p>
            </div>
          </div>
          <div class="controls">
            <button id="startBtn">‚ñ∂ Start Game</button>
          </div>
          <details style="margin-top:10px">
            <summary>How scoring works</summary>
            <p class="small">Base: 1000 points per round ‚àí 10 √ó seconds to solve + 50 √ó streak. Minimum per round is 50.</p>
          </details>
        </section>

        <section id="play" hidden>
          <div class="stats">
            <div class="kpi">Round <strong><span id="roundNow">1</span>/<span id="roundTotal">30</span></strong></div>
            <div class="kpi">Time <strong><span id="time">0.0</span>s</strong></div>
            <div class="kpi">Streak <strong><span id="streak">0</span></strong></div>
            <div class="kpi">Score <strong><span id="score">0</span></strong></div>
          </div>
          <div class="grid" id="grid" aria-live="polite"></div>
          <form id="guessForm" autocomplete="off" class="center">
            <label class="sr" for="guess">Your guess</label>
            <input id="guess" type="text" placeholder="Type the unscrambled word (no spaces)‚Ä¶" required />
            <div class="controls">
              <button type="submit">Submit</button>
              <button type="button" class="secondary" id="reshuffleBtn">Reshuffle</button>
              <button type="button" class="secondary" id="skipBtn">Skip</button>
            </div>
          </form>
          <div id="feedback" class="hint center"></div>
        </section>

        <section id="finish" hidden class="center">
          <div>
            <h2>üèÅ Game Over</h2>
            <p class="hint">Great run! Save your score to the private leaderboard.</p>
            <div class="kpi">Final Score: <strong id="finalScore">0</strong></div>
            <div style="margin-top:14px" class="nameEntry">
              <input id="playerName" type="text" placeholder="Display name" maxlength="24" />
              <button id="saveScoreBtn">Save</button>
            </div>
            <p id="saveStatus" class="hint" style="margin-top:6px"></p>
            <div style="margin-top:14px;display:flex;gap:8px;justify-content:center;flex-wrap:wrap">
              <button id="playAgainBtn">Play Again</button>
              <button class="secondary" id="copyLinkBtn">Copy Link</button>
            </div>

            <h3 style="margin-top:18px;font-size:15px">üèÜ Leaderboard</h3>
            <table id="board">
              <thead><tr><th>#</th><th>Name</th><th>Score</th><th>Time(s)</th><th>Date</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </section>
      </main>
      <div class="footer small">
        <div><span>Made for you ‚Äî link-only play.</span></div>
        <div class="toggle"><input type="checkbox" id="sounds" checked /> <label for="sounds">Sound FX</label></div>
      </div>
    </div>
  </div>

  <script>
    const FORM_ACTION = "https://docs.google.com/forms/d/e/1FAIpQLScpglp7w18EMoxlh8ynEj82G63jn7fZsvUgwTdMJKqt8CCBsQ/formResponse";
    const ENTRY_IDS = {name:"entry.1172479628",score:"entry.1803995992",totalTime:"entry.1884286962",seed:"entry.914252467",date:"entry.1001084897"};

    const WORDS = [
      "BROOKLYN","BRONX","QUEENS","MANHATTAN","RESOURCE","HARLEM","SOHO","ELLIMAN","TRIBECA","CHELSEA","ASTORIA","DUMBO","LEASE","TENANT","BROKER","ESCROW","MORTGAGE","TITLE","CLOSING","DEED","LIEN","COOP","LOFT","DUPLEX","CONDO","RENTAL","ZONING","LOT","BLOCK","PARCEL","AGENT","OFFER","LISTING","COMPASS","STUDIOPRO","STUDIO","EDEAL","COMMISSION",
      "APPRAISAL","EQUITY","LIABILITY","ASSET","CORCORAN","CAPRATE","VINCENT","REALTOR","MLS","SUBLET","EASEMENT","VARIANCE","LIQUIDITY","AMENITY","DUE","ESCALATION","REFINANCE","FORECLOSURE","INVESTOR","PORTFOLIO","CASHFLOW","CAPITAL","RENOVATION","PENTHOUSE","MULTIFAMILY","DEVELOPER","XPRESSDOCS","ASSESSMENT","VACANCY","UNDERWRITING","AMORTIZE","INTEREST","PRINCIPAL"
    ];

    let currentWord = "";
    let round = 0;
    let score = 0;
    let streak = 0;
    let totalTime = 0;
    let timerInterval;
    let startTime;

    const startBtn = document.getElementById("startBtn");
    const setup = document.getElementById("setup");
    const play = document.getElementById("play");
    const finish = document.getElementById("finish");
    const grid = document.getElementById("grid");
    const guessForm = document.getElementById("guessForm");
    const guessInput = document.getElementById("guess");
    const feedback = document.getElementById("feedback");
    const roundNow = document.getElementById("roundNow");
    const roundTotal = document.getElementById("roundTotal");
    const scoreEl = document.getElementById("score");
    const streakEl = document.getElementById("streak");
    const timeEl = document.getElementById("time");
    const progressBar = document.getElementById("progressBar");
    const finalScore = document.getElementById("finalScore");
    const playerName = document.getElementById("playerName");
    const saveScoreBtn = document.getElementById("saveScoreBtn");
    const saveStatus = document.getElementById("saveStatus");
    const board = document.getElementById("board").querySelector("tbody");

    roundTotal.textContent = 30;

    function shuffle(word){
      return word.split('')
        .map(v=>[Math.random(),v])
        .sort((a,b)=>a[0]-b[0])
        .map(x=>x[1])
        .join('');
    }

    function nextRound(){
      if(round>=30){
        endGame();
        return;
      }
      round++;
      roundNow.textContent=round;
      currentWord = WORDS[Math.floor(Math.random()*WORDS.length)];
      renderWord(currentWord);
      startTimer();
      feedback.textContent="";
      guessInput.value="";
      guessInput.focus();
    }

    function renderWord(word){
      grid.innerHTML="";
      shuffle(word).split('').forEach(l=>{
        const div=document.createElement("div");
        div.className="tile";
        div.textContent=l;
        grid.appendChild(div);
      });
    }

    function startTimer(){
      clearInterval(timerInterval);
      startTime=Date.now();
      timerInterval=setInterval(()=>{
        timeEl.textContent=((Date.now()-startTime)/1000).toFixed(1);
      },100);
    }

    function stopTimer(){
      clearInterval(timerInterval);
      const secs=(Date.now()-startTime)/1000;
      totalTime+=secs;
      return secs;
    }

    function endGame(){
      play.hidden=true;
      finish.hidden=false;
      finalScore.textContent=score;
    }

    startBtn.onclick=()=>{
      setup.hidden=true;
      play.hidden=false;
      round=0;score=0;streak=0;totalTime=0;progressBar.style.width='0%';
      nextRound();
    };

    guessForm.onsubmit=(e)=>{
      e.preventDefault();
      const guess=guessInput.value.trim().toUpperCase();
      if(!guess)return;
      if(guess===currentWord){
        const secs=stopTimer();
        const pts=Math.max(50,1000-Math.floor(secs*10)+50*streak);
        score+=pts;streak++;
        scoreEl.textContent=score;streakEl.textContent=streak;
        progressBar.style.width=((round/30)*100)+"%";
        nextRound();
      } else {
        feedback.textContent="Incorrect ¬∑ Try again";
      }
    };

    document.getElementById("reshuffleBtn").onclick=()=>{renderWord(currentWord)}
    document.getElementById("skipBtn").onclick=()=>{streak=0;streakEl.textContent=streak;stopTimer();progressBar.style.width=((round/30)*100)+"%";nextRound()}

    saveScoreBtn.onclick=()=>{
      const name=playerName.value.trim()||"Anonymous";
      const row=document.createElement("tr");
      row.innerHTML=`<td></td><td>${name}</td><td>${score}</td><td>${totalTime.toFixed(1)}</td><td>${new Date().toLocaleDateString()}</td>`;
      board.appendChild(row);
      [...board.querySelectorAll("tr")].forEach((r,i)=>r.firstChild.textContent=i+1);
      saveStatus.textContent="Saved locally.";

      const formData=new FormData();
      formData.append(ENTRY_IDS.name,name);
      formData.append(ENTRY_IDS.score,score);
      formData.append(ENTRY_IDS.totalTime,totalTime.toFixed(1));
      formData.append(ENTRY_IDS.seed,Math.random().toString(36).substring(2,8));
      formData.append(ENTRY_IDS.date,new Date().toISOString());
      fetch(FORM_ACTION,{method:"POST",mode:"no-cors",body:formData});
    };

    document.getElementById("playAgainBtn").onclick=()=>{finish.hidden=true;setup.hidden=false}
    document.getElementById("copyLinkBtn").onclick=()=>{navigator.clipboard.writeText(window.location.href);saveStatus.textContent="Link copied!"}

    const sndToggle=document.getElementById("sounds");
    let audioCtx=null;
    function ensureAudio(){if(!audioCtx){audioCtx=new (window.AudioContext||window.webkitAudioContext)();}}
    function env(gain,attack,decay){const now=audioCtx.currentTime;gain.gain.cancelScheduledValues(now);gain.gain.setValueAtTime(0,now);gain.gain.linearRampToValueAtTime(0.9,now+attack);gain.gain.exponentialRampToValueAtTime(0.0001,now+attack+decay)}
    function playTone(freq,type,dur,attack,decay,pan){if(!sndToggle.checked)return;ensureAudio();const o=audioCtx.createOscillator();const g=audioCtx.createGain();const p=audioCtx.createStereoPanner?audioCtx.createStereoPanner():null;o.type=type;o.frequency.value=freq;env(g,attack,decay);o.connect(g);let dest=g;if(p){p.pan.value=pan||0;g.connect(p);dest=p}dest.connect(audioCtx.destination);o.start();o.stop(audioCtx.currentTime+dur)}
    function chord(freqs,type,dur){if(!sndToggle.checked)return;ensureAudio();const now=audioCtx.currentTime;const master=audioCtx.createGain();master.gain.value=0.6;master.connect(audioCtx.destination);freqs.forEach((f,i)=>{const o=audioCtx.createOscillator();const g=audioCtx.createGain();o.type=type;o.frequency.value=f;g.gain.setValueAtTime(0,now);g.gain.linearRampToValueAtTime(0.7/(i+1),now+0.04*i);g.gain.exponentialRampToValueAtTime(0.0001,now+dur);o.connect(g);g.connect(master);o.start(now+0.02*i);o.stop(now+dur)});}
    function arpeggio(freqs,type,step,count){if(!sndToggle.checked)return;ensureAudio();for(let i=0;i<count;i++){const f=freqs[i%freqs.length];setTimeout(()=>playTone(f,type,0.22,0.01,0.18,(i%2?0.2:-0.2)),i*step)} }
    function playClick(){playTone(220,"square",0.09,0.005,0.06,0)}
    function playCorrect(){chord([659.25,880,987.77],"sine",0.5)}
    function playWrong(){playTone(180,"sawtooth",0.25,0.005,0.22,0);setTimeout(()=>playTone(140,"sawtooth",0.25,0.005,0.22,0),90)}
    function playGameOver(){arpeggio([392,494,523,659],"sine",120,6)}

    [startBtn,document.getElementById("reshuffleBtn"),document.getElementById("skipBtn"),saveScoreBtn,document.getElementById("playAgainBtn"),document.getElementById("copyLinkBtn")].forEach(btn=>{if(btn){btn.addEventListener("click",()=>playClick(),{capture:true})}});

    const _origEndGame=endGame;endGame=()=>{_origEndGame();playGameOver()};

    const _originalSubmit=guessForm.onsubmit;
    guessForm.onsubmit=(e)=>{
      const wasCorrect = guessInput.value.trim().toUpperCase()===currentWord;
      _originalSubmit(e);
      if(wasCorrect){ playCorrect(); }
      else if(guessInput.value.trim()){ playWrong(); }
    };
  // === File-based sounds (drop files in /sounds) ===
const sCorrect  = new Audio("sounds/correct.mp3");
const sWrong    = new Audio("sounds/wrong.mp3");
const sClick    = new Audio("sounds/click.mp3");
const sGameOver = new Audio("sounds/gameover.mp3");
[sCorrect,sWrong,sClick,sGameOver].forEach(a=>{a.preload="auto";a.volume=0.35});
function playFile(a){if(!document.getElementById("sounds").checked)return;try{a.currentTime=0;a.play()}catch(e){}}
function playClick(){playFile(sClick)}
function playCorrect(){playFile(sCorrect)}
function playWrong(){playFile(sWrong)}
function playGameOver(){playFile(sGameOver)}
// prime audio once on first gesture (iOS/Safari)
function primeAudio(){[sCorrect,sWrong,sClick,sGameOver].forEach(a=>{a.play().then(()=>{a.pause();a.currentTime=0}).catch(()=>{})})}
window.addEventListener('click',primeAudio,{once:true});

// --- Background Music (robust) ---
const bgMusic = new Audio("sounds/bg-music.mp3"); // change if your filename differs
bgMusic.loop = true;
bgMusic.volume = 0.35;

function startBackgroundMusic() {
  if (!document.getElementById("sounds").checked) return;
  try { bgMusic.currentTime = 0; bgMusic.play(); } catch(e){}
}
function stopBackgroundMusic() {
  try { bgMusic.pause(); bgMusic.currentTime = 0; } catch(e){}
}

// Prime audio once (iOS/Safari) and start if on menu/finish screens
window.addEventListener("click", () => {
  try { bgMusic.play().then(() => { bgMusic.pause(); bgMusic.currentTime = 0; }).catch(()=>{}); } catch(e){}
  if (!document.getElementById("play").hidden) return; // in-game: keep silent
  startBackgroundMusic();
}, { once: true });

// Stop when game starts
startBtn.addEventListener("click", () => { stopBackgroundMusic(); });

// Resume when game ends
const __origEndGame = endGame;
endGame = () => {
  __origEndGame();
  playGameOver();
  startBackgroundMusic();
};

// Resume when returning to setup
document.getElementById("playAgainBtn").addEventListener("click", () => {
  startBackgroundMusic();
});

// Live toggle: mute/unmute bg immediately
document.getElementById("sounds").addEventListener("change", e => {
  if (e.target.checked) {
    if (!document.getElementById("play") || document.getElementById("play").hidden) {
      startBackgroundMusic(); // only on setup/finish
    }
  } else {
    stopBackgroundMusic();
  }
});

// Optional: log if the file couldn't load (helps debug path issues)
bgMusic.addEventListener("error", () => {
  console.warn("[audio] bg-music failed to load. Check path/filename:", bgMusic.src);
});
</script>
</body>
</html>
